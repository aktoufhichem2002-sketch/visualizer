<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Visualiseur Audio Simple</title>
<style>
  html, body {
    margin: 0;
    background: #000;
    overflow: hidden;
  }
  #file {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 10;
    padding: 10px 14px;
    background: #ffffff22;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-family: sans-serif;
  }
  input { display: none; }
  canvas {
    position: fixed;
    inset: 0;
  }
</style>
</head>
<body>

<label id="file">
  Charger un audio
  <input type="file" id="audioFile" accept="audio/*">
</label>

<canvas id="canvas"></canvas>

<script>
const fileInput = document.getElementById("audioFile");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let audioCtx, analyser, data, source;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.onresize = resize;

// Projet : simple waveform + anneau
function draw() {
  requestAnimationFrame(draw);
  if (!analyser) return;

  analyser.getByteFrequencyData(data);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // --- ANNEAU ---
  const cx = canvas.width/2;
  const cy = canvas.height/2;
  const radius = Math.min(canvas.width, canvas.height)*0.25;
  ctx.beginPath();
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#d4af37"; // or
  const n = data.length;
  for (let i=0; i<n; i++) {
    const angle = (i/n) * Math.PI*2;
    const amp = data[i]/255;
    const r = radius + amp*40;
    const x = cx + Math.cos(angle)*r;
    const y = cy + Math.sin(angle)*r;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.stroke();

  // --- WAVEFORM ---
  analyser.getByteTimeDomainData(data);
  ctx.beginPath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#ffffff";
  const mid = cy + radius + 80;
  for (let i=0; i<n; i++) {
    const x = (i/n)*canvas.width;
    const y = mid + ((data[i]-128)/128)*80;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

fileInput.addEventListener("change", async function() {
  const file = this.files[0];
  if (!file) return;

  // Contexte audio
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.frequencyBinCount);

  // CrÃ©ation Audio
  const audio = new Audio();
  audio.src = URL.createObjectURL(file);
  audio.loop = true;
  audio.crossOrigin = "anonymous";
  await audio.play();

  // Connexion graphe audio
  const src = audioCtx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);

  draw();
});
</script>
</body>
</html>
